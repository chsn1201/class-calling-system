<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>è¯¾å ‚ç‚¹åç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { height: 400px; margin-top: 30px; }
    </style>
</head>
<body class="container mt-4">
<h1>è¯¾å ‚ç‚¹åç³»ç»Ÿ</h1>
<a class="btn btn-primary" href="/upload">å¯¼å…¥å­¦ç”Ÿåå•</a>
<a class="btn btn-info" href="/export" download="points.csv">å¯¼å‡ºç§¯åˆ†è¯¦å•</a>

<h2 class="mt-4">ç‚¹åæ¨¡å¼</h2>
<button class="btn btn-warning" onclick="randomCall()">éšæœºç‚¹å</button>
<button class="btn btn-secondary" onclick="sequentialCallOne()">æŒ‰å­¦å·é¡ºåºç‚¹å</button>

<div id="result" class="mt-3 alert alert-info" style="display:none;"></div>

<!-- ğŸ“Š æ’åå¯è§†åŒ–åŒºåŸŸ -->
<div class="chart-container">
    <h3>ç§¯åˆ†ä¸ç‚¹åæ¬¡æ•° Top 10</h3>
    <canvas id="rankingChart"></canvas>
</div>

<script>
    // ========== ç‚¹åé€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰==========
    function randomCall() {
        fetch('/call/random')
            .then(res => res.json())
            .then(data => {
                if (data) {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('result').innerHTML =
                        `<strong>éšæœºç‚¹åˆ°ï¼š</strong> ${data.name} (${data.studentId})`;
                    askScoreFeedback(data.studentId, data.name);
                    // æ›´æ–°å›¾è¡¨
                    loadRankingChart();
                } else {
                    alert('æš‚æ— å­¦ç”Ÿæ•°æ®ï¼');
                }
            });
    }

    function sequentialCallOne() {
        fetch('/call/sequential')
            .then(res => res.json())
            .then(data => {
                if (data) {
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('result').innerHTML =
                        `<strong>é¡ºåºç‚¹åˆ°ï¼š</strong> ${data.name} (${data.studentId})`;
                    askScoreFeedback(data.studentId, data.name); // å¤ç”¨è¯„åˆ†é€»è¾‘
                } else {
                    alert('æš‚æ— å­¦ç”Ÿæ•°æ®ï¼');
                }
            })
            .catch(err => {
                console.error('é¡ºåºç‚¹åå¤±è´¥:', err);
                alert('ç‚¹åå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®');
            });
    }

    function askScoreFeedback(studentId, studentName) {
        const arrived = confirm(`è¯¥åŒå­¦æ˜¯å¦åˆ°è¾¾è¯¾å ‚ï¼Ÿ\nï¼ˆç‚¹åˆ°ï¼š${studentName}ï¼‰`);
        if (!arrived) return;

        const repeatCorrect = confirm(`æ˜¯å¦å‡†ç¡®é‡å¤äº†é—®é¢˜ï¼Ÿ\nï¼ˆå­¦ç”Ÿï¼š${studentName}ï¼‰`);
        let score = 1.0;
        if (repeatCorrect) {
            score += 0.5;
        } else {
            score -= 1.0;
        }

        const answerCorrect = confirm(`æ˜¯å¦å‡†ç¡®å›ç­”äº†é—®é¢˜ï¼Ÿ\nï¼ˆå­¦ç”Ÿï¼š${studentName}ï¼‰`);
        if (answerCorrect) {
            const bonus = prompt(`è¯·ç»™å‡ºé¢å¤–åŠ åˆ†ï¼ˆ0.5 ~ 3ï¼‰ï¼š\nï¼ˆå­¦ç”Ÿï¼š${studentName}ï¼‰`, "1");
            const bonusNum = parseFloat(bonus);
            score += isNaN(bonusNum) ? 1 : bonusNum;
        }

        fetch('/score/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `studentId=${encodeURIComponent(studentId)}&points=${score}`
        }).then(() => {
            alert(`âœ… å·²ä¸º ${studentName} è®°å½•ç§¯åˆ†ï¼š${score.toFixed(2)}`);
            loadRankingChart(); // æ›´æ–°å›¾è¡¨
        }).catch(err => {
            alert('âŒ ç§¯åˆ†æ›´æ–°å¤±è´¥');
            console.error(err);
        });
    }

    // ========== æ–°å¢ï¼šåŠ è½½æ’åå›¾è¡¨ ==========
    let rankingChartInstance = null;

    function loadRankingChart() {
        fetch('/api/ranking')
            .then(res => res.json())
            .then(students => {
                const names = students.map(s => s.name);
                const scores = students.map(s => s.score);
                const calls = students.map(s => s.callCount);

                const ctx = document.getElementById('rankingChart').getContext('2d');

                // é”€æ¯æ—§å›¾è¡¨ï¼ˆé¿å…é‡å ï¼‰
                if (rankingChartInstance) {
                    rankingChartInstance.destroy();
                }

                rankingChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: names,
                        datasets: [
                            {
                                label: 'æ€»ç§¯åˆ†',
                                data: scores,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'éšæœºç‚¹åæ¬¡æ•°',
                                data: calls,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 1 }
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                });
            })
            .catch(err => console.error('åŠ è½½æ’åå¤±è´¥:', err));
    }

    // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åŠ è½½å›¾è¡¨
    document.addEventListener('DOMContentLoaded', () => {
        loadRankingChart();
    });
</script>
</body>
</html>